{% extends 'main/layout.html' %}
{% load static %}

{% block title %}
    Главная страница
{% endblock %}

{% block content %}
    <div class="container">

        <div class="filters">
            <div class="filter-group">
                {% if user.is_superuser %}
                    <label for="employee-filter">Сотрудник:</label>
                    <select id="employee-filter" class="filter-input" name="employee_filter">
                        <option value="">Все сотрудники</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}" {% if current_filters.employee == emp.id|stringformat:"s" %}selected{% endif %}>{{ emp.username }}</option>
                        {% endfor %}
                    </select>
                {% elif user.is_authenticated %}
                    <label for="employee-display">Сотрудник:</label>
                    <select id="employee-display" class="filter-input" disabled>
                        <option selected>{{ user.username }}</option>
                    </select>
                {% endif %}
            </div>

            <div class="filter-group">
                <label for="start-date">Начало периода:</label>
                <input type="date" id="start-date" class="filter-input" value="{{ current_filters.start_date|default:'' }}">
            </div>

            <div class="filter-group">
                <label for="end-date">Конец периода:</label>
                <input type="date" id="end-date" class="filter-input" value="{{ current_filters.end_date|default:'' }}">
            </div>

            <button id="apply-filters-btn" class="filter-button">
                <i class="fas fa-filter"></i> Применить
            </button>
        </div>

        <button id="add-row-btn" class="button" type="button">
            <i class="fa-duotone fa-solid fa-plus"></i>
        </button>
        <table id="timesheet-table" class="time-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Сотрудник</th>
                    <th>Проект</th>
                    <th>Кол-во часов</th>
                    <th>Комментарий</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% if timeSheet %}
                    {% for item in timeSheet %}
                        <tr data-id="{{ item.id }}">
                            <td>{{ item.date|date:"Y-m-d" }}</td>
                            <td>{{ item.worker.username }}</td>
                            <td>{{ item.project.name }}</td>
                            <td>{{ item.hours_number }}</td>
                            <td>{{ item.comment }}</td>
                            <td>
                                <button class="button edit-row-btn" title="Редактировать">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="button delete-row-btn" title="Удалить">
                                     <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6"><p style="text-align: center; padding: 10px;">Пока нет записей</p></td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        const projectsData = [
            {% for project in projects %}
                { id: "{{ project.id }}", name: "{{ project.name|escapejs }}" },
            {% endfor %}
        ];
        const csrfToken = "{{ csrf_token }}";
        const addEntryUrl = "{% url 'add_timesheet_entry' %}";
        const currentUserUsername = "{{ current_user.username|escapejs }}";

        document.addEventListener("DOMContentLoaded", function () {
            const addButton = document.getElementById("add-row-btn");
            const tableBody = document.querySelector("#timesheet-table tbody");
            const noRecordsRow = tableBody.querySelector('td > p'); // Для удаления сообщения "Пока нет записей"

            if (addButton) {
                addButton.addEventListener("click", function () {
                    if (tableBody.querySelector('tr.new-entry-row')) {
                        alert("Пожалуйста, сначала сохраните или отмените текущую новую запись.");
                        return;
                    }

                    const newRow = tableBody.insertRow(0); // Вставляем в начало tbody
                    newRow.classList.add('new-entry-row');

                    let projectOptionsHTML = '<option value="">Выберите проект</option>';
                    projectsData.forEach(project => {
                        projectOptionsHTML += `<option value="${project.id}">${project.name}</option>`;
                    });

                    const today = new Date().toISOString().split('T')[0];

                    newRow.innerHTML = `
                        <td><input type="date" name="date" value="${today}" style="width:100%"/></td>
                        <td>${currentUserUsername}</td>
                        <td>
                            <select name="project" style="width:100%">
                                ${projectOptionsHTML}
                            </select>
                        </td>
                        <td><input type="number" name="hours_number" min="0" step="0.5" style="width:100%"/></td>
                        <td><input type="text" name="comment" style="width:100%"/></td>
                        <td>
                            <button class="save-row button" title="Сохранить"><i class="fas fa-check"></i></button>
                            <button class="cancel-row button" title="Отменить"><i class="fas fa-times"></i></button>
                        </td>
                    `;

                    if (noRecordsRow && tableBody.rows.length > 1) { // Если была строка "нет записей" и добавили новую
                        const parentRow = noRecordsRow.closest('tr');
                        if(parentRow) parentRow.remove();
                    }


                    newRow.querySelector(".cancel-row").addEventListener("click", () => {
                        newRow.remove();
                         // Если после удаления новой строки таблица пуста (только заголовок), вернуть сообщение
                        if (tableBody.rows.length === 0 && !document.querySelector("#timesheet-table tbody tr")) {
                            tableBody.innerHTML = '<tr><td colspan="6"><p style="text-align: center; padding: 10px;">Пока нет записей</p></td></tr>';
                        }
                    });

                    newRow.querySelector(".save-row").addEventListener("click", () => {
                        const dateInput = newRow.querySelector('[name="date"]');
                        const projectSelect = newRow.querySelector('[name="project"]');
                        const hoursInput = newRow.querySelector('[name="hours_number"]');
                        const commentInput = newRow.querySelector('[name="comment"]');

                        const date = dateInput.value;
                        const projectId = projectSelect.value;
                        const hours = hoursInput.value;
                        const comment = commentInput.value;

                        if (!date) { alert("Пожалуйста, выберите дату."); dateInput.focus(); return; }
                        if (!projectId) { alert("Пожалуйста, выберите проект."); projectSelect.focus(); return; }
                        if (hours === "" || parseFloat(hours) < 0) { alert("Пожалуйста, введите корректное количество часов (не отрицательное)."); hoursInput.focus(); return; }
                        // Допустимо 0 часов, если это имеет смысл для вашего приложения, иначе parseFloat(hours) <= 0

                        fetch(addEntryUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": csrfToken,
                            },
                            body: JSON.stringify({
                                date: date,
                                project_id: projectId, // Отправляем ID проекта
                                hours_number: hours,
                                comment: comment,
                            }),
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errData => {
                                    throw new Error(errData.error || `Ошибка сервера: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                location.reload(); // Перезагружаем страницу для отображения новой записи
                            } else {
                                alert("Ошибка при добавлении записи: " + (data.error || "Неизвестная ошибка."));
                            }
                        })
                        .catch(error => {
                            console.error("Fetch error:", error);
                            alert("Произошла ошибка при отправке данных: " + error.message);
                        });
                    });
                });
            }

            // Обработчик для кнопки "Применить фильтры"
            const applyFiltersButton = document.getElementById('apply-filters-btn');
            if (applyFiltersButton) {
                applyFiltersButton.addEventListener('click', function() {
                    const employeeId = document.getElementById('employee-filter').value;
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;

                    let queryParams = new URLSearchParams();
                    if (employeeId) queryParams.append('employee', employeeId);
                    if (startDate) queryParams.append('start_date', startDate);
                    if (endDate) queryParams.append('end_date', endDate);

                    // Перенаправляем на текущий URL с новыми GET-параметрами
                    window.location.search = queryParams.toString();
                });
            }

            document.querySelectorAll('.delete-row-btn').forEach(button => {
                button.addEventListener('click', handleDeleteClick);
            });

            // Привязка к существующим кнопкам редактирования (добавим обработчик позже)
            document.querySelectorAll('.edit-row-btn').forEach(button => {
                button.addEventListener('click', handleEditClick); // handleEditClick определим ниже
            });

        });
        function handleDeleteClick() {
            const row = this.closest('tr');
            const entryId = row.dataset.id;
            const deleteEntryUrlTemplate = "{% url 'delete_timesheet_entry' 0 %}"; // Шаблон URL

            if (entryId && confirm('Вы уверены, что хотите удалить эту запись?')) {
                const deleteUrl = deleteEntryUrlTemplate.replace('0', entryId); // Формируем URL

                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken, // csrfToken должен быть определен ранее
                        'Content-Type': 'application/json' // Даже если тело пустое, лучше указать
                    },
                    // body: JSON.stringify({}) // Тело не нужно для этого запроса
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `Ошибка сервера: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        row.remove();
                        const tableBody = document.querySelector("#timesheet-table tbody");
                        if (tableBody.rows.length === 0 && !tableBody.querySelector("tr")) {
                            tableBody.innerHTML = '<tr><td colspan="6"><p style="text-align: center; padding: 10px;">Пока нет записей</p></td></tr>';
                        }
                        // alert(data.message || 'Запись удалена!'); // Опционально
                    } else {
                        alert('Ошибка удаления: ' + (data.error || 'Неизвестная ошибка.'));
                    }
                })
                .catch(error => {
                    console.error("Delete error:", error);
                    alert("Произошла ошибка при удалении записи: " + error.message);
                });
            }
        }

        const updateEntryUrlTemplate = "{% url 'update_timesheet_entry' 0 %}"; // Шаблон URL

        // Именованная функция для обработчика клика по кнопке "Редактировать"
        function handleEditClick() {
            const row = this.closest('tr');
            if (row.classList.contains('editing')) return; // Уже в режиме редактирования

            row.classList.add('editing');
            const cells = Array.from(row.querySelectorAll('td'));
            const entryId = row.dataset.id;

            // Сохраняем оригинальные значения для отмены
            const originalValues = {
                date: cells[0].textContent.trim(),
                project: cells[2].textContent.trim(),
                hours: cells[3].textContent.trim(),
                comment: cells[4].textContent.trim(),
                actions: cells[5].innerHTML // Сохраняем HTML кнопок
            };

            // Находим текущий проект для pre-selection в select
            const currentProject = projectsData.find(p => p.name === originalValues.project);
            const currentProjectId = currentProject ? currentProject.id : "";

            let projectOptionsHTML = '<option value="">Выберите проект</option>';
            projectsData.forEach(project => { // projectsData должен быть доступен глобально в скрипте
                projectOptionsHTML += `<option value="${project.id}" ${project.id == currentProjectId ? 'selected' : ''}>${project.name}</option>`;
            });

            // Заменяем текст на поля ввода
            cells[0].innerHTML = `<input type="date" name="edit-date" value="${originalValues.date}" class="form-control form-control-sm">`;
            // cells[1] (Сотрудник) не редактируем здесь
            cells[2].innerHTML = `<select name="edit-project" class="form-control form-control-sm">${projectOptionsHTML}</select>`;
            cells[3].innerHTML = `<input type="number" name="edit-hours" value="${originalValues.hours}" min="0" step="0.5" class="form-control form-control-sm">`;
            cells[4].innerHTML = `<input type="text" name="edit-comment" value="${originalValues.comment}" class="form-control form-control-sm">`;
            cells[5].innerHTML = `
                <button class="button save-edit-btn" title="Сохранить"><i class="fas fa-check"></i></button>
                <button class="button cancel-edit-btn" title="Отмена"><i class="fas fa-times"></i></button>
            `;

            // Обработчик для "Сохранить изменения"
            row.querySelector('.save-edit-btn').addEventListener('click', function() {
                const updatedData = {
                    date: row.querySelector('[name="edit-date"]').value,
                    project_id: row.querySelector('[name="edit-project"]').value,
                    hours_number: row.querySelector('[name="edit-hours"]').value,
                    comment: row.querySelector('[name="edit-comment"]').value,
                };

                // Простая валидация на клиенте
                if (!updatedData.date || !updatedData.project_id || updatedData.hours_number === "" || parseFloat(updatedData.hours_number) < 0) {
                    alert("Пожалуйста, заполните все обязательные поля корректно (дата, проект, часы >= 0).");
                    return;
                }

                const updateUrl = updateEntryUrlTemplate.replace('0', entryId);

                fetch(updateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(errData => {
                            throw new Error(errData.error || `Ошибка сервера: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.entry) {
                        // Обновляем ячейки в таблице новыми данными
                        cells[0].textContent = data.entry.date;
                        cells[1].textContent = data.entry.worker_username; // Сотрудник может не меняться, но лучше обновить из ответа
                        cells[2].textContent = data.entry.project_name;
                        cells[3].textContent = data.entry.hours_number;
                        cells[4].textContent = data.entry.comment;
                        cells[5].innerHTML = originalValues.actions; // Восстанавливаем кнопки "Редактировать/Удалить"

                        row.classList.remove('editing');
                        // Перепривязываем обработчики к восстановленным кнопкам
                        row.querySelector('.edit-row-btn').addEventListener('click', handleEditClick);
                        row.querySelector('.delete-row-btn').addEventListener('click', handleDeleteClick);
                    } else {
                        alert('Ошибка обновления: ' + (data.error || 'Неизвестная ошибка.'));
                    }
                })
                .catch(error => {
                    console.error("Update error:", error);
                    alert("Произошла ошибка при обновлении записи: " + error.message);
                    // Можно откатить изменения к originalValues или оставить поля для исправления
                });
            });

            // Обработчик для "Отмена"
            row.querySelector('.cancel-edit-btn').addEventListener('click', function() {
                cells[0].textContent = originalValues.date;
                // cells[1] не меняли
                cells[2].textContent = originalValues.project;
                cells[3].textContent = originalValues.hours;
                cells[4].textContent = originalValues.comment;
                cells[5].innerHTML = originalValues.actions; // Восстанавливаем кнопки

                row.classList.remove('editing');
                // Перепривязываем обработчики к восстановленным кнопкам
                row.querySelector('.edit-row-btn').addEventListener('click', handleEditClick);
                row.querySelector('.delete-row-btn').addEventListener('click', handleDeleteClick);
            });
        }

    </script>
{% endblock %}